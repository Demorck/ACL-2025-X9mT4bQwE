<div class="mb-4 p-3" data-view="<%= view %>" id="container-filter">
    <h2 class="text-lg font-semibold mb-2">Agendas</h2>
    <div class="flex flex-wrap flex-row sm:flex-col gap-3">
        <% data.agendas.forEach(a => { 
            %>
            <label class="flex items-center gap-2 cursor-pointer">
                <input 
                    type="checkbox" 
                    class="agenda-toggle" 
                    value="<%= a._id %>" 
                    checked
                >
                <span 
                    class="filter-color filter-color-<%= a.couleur %>"
                ></span>
                <div class="flex flex-col flex-1">
                    <span class="font-medium"><%= a.nom %></span>
                    <% if (typeof a.niveau !== 'undefined') { %>
                        <span class="text-xs opacity-70">
                            <%= a.niveau === 4 ? 'Propriétaire' : a.niveau === 3 ? 'Admin' : a.niveau === 2 ? 'Member' : 'Viewer' %>
                        </span>
                    <% } %>
                </div>
            </label>
        <% }) %>
    </div>
</div>

<script>
/**
 * Gère le placement des rendez-vous avec le filtre (vue jour/semaine).
 */
function layoutAppointments() {
    let days = [];

    document.querySelectorAll(".appointment").forEach(el => {
        if (el.style.display === "none") return;
        let day = el.dataset.day;
        let start = parseFloat(el.dataset.start);
        let duration = parseFloat(el.dataset.duration);
        let end = start + duration;

        if (!days[day]) days[day] = [];
        days[day].push({ el, start, duration, end });
    });

    Object.values(days).forEach(appointments => {
        appointments.sort((a, b) => a.start - b.start);
        let columns = [];

        appointments.forEach(appt => {
            let placed = false;
            for (let i = 0; i < columns.length; i++) {
                let col = columns[i];
                let last = col[col.length - 1];
                let lastEnd = last.start + last.duration;
                if (lastEnd <= appt.start) {
                    col.push(appt);
                    placed = true;
                    break;
                }
            }
            if (!placed) columns.push([appt]);
        });

        let colCount = columns.length;

        columns.forEach((col, i) => {
            col.forEach(appt => {
                let span = 1;
                for (let j = i + 1; j < columns.length; j++) {
                    let overlap = columns[j].some(c => !(appt.end <= c.start || appt.start >= c.end));
                    if (overlap) break;
                    span++;
                }

                let width = span * 100 / colCount;
                appt.el.style.left = `${(100 / colCount) * i}%`;
                appt.el.style.width = `${width}%`;
            });
        });
    });
}

/**
 * Sauvegarde les filtres dans le localStorage
 */
function setLocalStorageFilter(checkboxes) {
    localStorage.setItem("agenda-filter", Array.from(checkboxes).filter(e => !e.checked).map(e => e.value))
}

/**
 * Applique le filtre d'agenda selon la vue actuelle
 */
function applyAgendaFilter(agendaId, visible, view) {
    switch (view) {
        case "month":
            // Vue mois : toggle class hidden
            document.querySelectorAll(`.appointment-month[data-agenda="${agendaId}"]`)
                .forEach(el => {
                    if (visible) {
                        el.classList.remove("hidden");
                    } else {
                        el.classList.add("hidden");
                    }
                });
            break;
        
        case "year":
            // Vue année : toggle class hidden
            document.querySelectorAll(`.appointment-year[data-agenda="${agendaId}"]`)
                .forEach(el => {
                    if (visible) {
                        el.classList.remove("hidden");
                    } else {
                        el.classList.add("hidden");
                    }
                });
            break;
        
        case "list":
            // Vue liste : toggle display sur les rendez-vous
            document.querySelectorAll(`[data-appointment][data-agenda="${agendaId}"]`)
                .forEach(el => {
                    el.style.display = visible ? "flex" : "none";
                });
            
            // Masquer les groupes de date vides
            document.querySelectorAll(".inner-container").forEach(container => {
                const visibleAppointments = Array.from(
                    container.querySelectorAll("[data-appointment]")
                ).filter(el => el.style.display !== "none");
                
                if (visibleAppointments.length === 0) {
                    container.style.display = "none";
                } else {
                    container.style.display = "block";
                }
            });
            break;
        
        default:
            // Vue jour/semaine : toggle display et relayout
            document.querySelectorAll(`.appointment[data-agenda='${agendaId}']`)
                .forEach(el => {
                    el.style.display = visible ? "block" : "none";
                });
            layoutAppointments();
            break;
    }
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    let toggles = document.querySelectorAll(".agenda-toggle");
    let default_visibleID = localStorage.getItem("agenda-filter");
    if (default_visibleID != null) {
        default_visibleID = default_visibleID.split(",");
    }
    
    toggles.forEach(toggle => {
        toggle.addEventListener("change", () => {
            let agendaId = toggle.value;
            let visible = toggle.checked;
            let view = document.querySelector('#container-filter');
            view = view.dataset.view;
            
            // Appliquer le filtre selon la vue
            applyAgendaFilter(agendaId, visible, view);
            
            // Sauvegarder dans localStorage
            setLocalStorageFilter(toggles);
        });

        // Appliquer les filtres sauvegardés
        if (default_visibleID != null) {
            let exist = default_visibleID.includes(toggle.value);
            if (exist) {
                toggle.click();
            }
        }
    });

    // Layout initial pour les vues jour/semaine
    let view = document.querySelector('#container-filter')?.dataset.view;
    if (view === "day" || view === "week") {
        layoutAppointments();
    }
});
</script>