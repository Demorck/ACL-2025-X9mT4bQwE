<header class="shadow-sm border-b-4 w-full">
  <div class="container mx-auto px-6 py-2 flex flex-col md:flex-row justify-between items-center">
    <a href="/calendar/day" class="text-xl font-bold hover:text-amber-300 hidden md:flex">
      Mon SUPER Agenda (trop slaaay)
    </a>

    <%- include("desktop-header") %>
    
    <div class="md:hidden flex items-left">
      <button id="mobile-menu-button" class="text-2xl">
        <i class="fa fa-bars"></i>
      </button>
    </div>
  </div>

</header>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    let variableI = document.querySelector(".fa-magnifying-glass");
    let recherche = document.querySelector("#recherche");
    let visible = document.querySelectorAll(".test");
    let resultats = document.querySelector("#resultats");

    // permet le bon affichage de la barre de recherche
    const afficherCacherRecherche = () => {
        visible.forEach(element => {
            element.classList.toggle("hidden");
        });
    }

    // listener pour afficher la barre de recherche et mettre le focus dessus
    variableI.addEventListener("click", () => {
        afficherCacherRecherche();
        if(visible){
          recherche.focus();
        }
    })

    // permet d'enlever l'affichage de la barre de recherche lorsqu'on enleve le focus
    document.addEventListener("click", (event) => {
        if (recherche.classList.contains("hidden")) return;
        if(!(recherche.parentElement.contains(event.target) || variableI.contains(event.target))){
          recherche.value="";
          resultats.innerHTML="";        
          afficherCacherRecherche();
      }
    });

    // Permet la recherche dans la bdd des rendez vous et l'affichage du jour du rdv si on clique dessus
    recherche.addEventListener("input", () => { 
        let str = recherche.value;
        fetch("/api/rechercher/recherche", {
          method: "POST",
          headers: { "Content-Type": "application/json;charset=UTF-8" },
          body: JSON.stringify({str})
        })
        .then(response => {
          // Traitement erreur 404
          if(!response.ok) {
            throw new Error("Erreur 404 lors de la recherche de rendez-vous (header.js)");
          }
          return response.json();
        }) 
        .then(data => { // utilisation des données résultats
          let newTextResultat="";
          if (data && data.length > 0) {
            data.forEach(element => {
              const date = new Date(element.date_Debut);
              const day = date.getUTCDate();             
              const month = date.getUTCMonth();
              const year = date.getUTCFullYear();
            
              // création d’un lien cliquable
              newTextResultat += `
                <div class="p-2 hover:bg-gray-200 cursor-pointer" onclick="window.location.href='/calendar/day?day=${day}&month=${month}&year=${year}'">
                  ${element.nom} - ${day}/${month + 1}/${year}
                </div>`;
            });
          }
          resultats.innerHTML=newTextResultat;
        }).catch(err => console.error(err));
    });
  })
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  let mobileButton = document.getElementById("mobile-menu-button");
  let mobileMenu = document.querySelector("nav");

  mobileButton.addEventListener("click", () => {
    mobileMenu.classList.toggle("hidden");
    mobileMenu.classList.toggle("flex");
  });


  let themeMenu = document.getElementById("theme-menu");
  let themeToggle = document.getElementById("theme-toggle");
  let themeLabel = document.getElementById("theme-label");
  let themeIcon = document.getElementById("theme-icon");

  let themes = {};

  let themes_el = document.querySelectorAll('[data-theme]');
  themes_el.forEach((el) => {
    let themeCode = el.dataset.theme;
    let label = el.querySelector("span").textContent;
    let fa = el.querySelector("i");

    let icon = Array.from(fa.classList).find(cl => cl.match("^fa-"));
    
    themes[themeCode] = { icon, label}
  })
  
  function applyTheme(theme) {
    document.body.className = theme;
    themeLabel.textContent = themes[theme].label;
    themeIcon.className = `fa ${themes[theme].icon}`;

    themes_el.forEach(el => el.classList.remove("theme-active"));
    let theme_el = document.querySelector(`[data-theme=${theme}]`).classList.add("theme-active");

    localStorage.setItem("theme", theme);
    fetch("/api/accounts/edit/theme", {
      method: "POST",
      headers: { "Content-Type": "application/json;charset=UTF-8" },
      body: JSON.stringify({ theme }),
    }).catch(console.error);
  }

  let savedTheme = localStorage.getItem("theme") || "dark";
  applyTheme(savedTheme);

  themeToggle.addEventListener("click", () => {
    themeMenu.classList.toggle("hidden");
  });

  themes_el.forEach(item => {
    item.addEventListener("click", () => {
      let selectedTheme = item.getAttribute("data-theme");
      applyTheme(selectedTheme);
      themeMenu.classList.add("hidden");
    });
  });

  document.addEventListener("click", (e) => {
    if (!themeToggle.contains(e.target) && !themeMenu.contains(e.target)) {
      themeMenu.classList.add("hidden");
    }
  });
});
</script>