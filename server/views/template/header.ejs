<header class="shadow-sm border-b-4">
  <div class="container mx-auto px-6 py-2 flex justify-between items-center">
    <a href="/" class="text-xl font-bold hover:text-amber-300">
      Mon SUPER Agenda (trop slaaay)
    </a>
    <nav class="space-x-4 flex items-center">
      <% if (user) {
       %>
       <div class="relative">
        <input type="text" name="recherche" id="recherche" placeholder=" Recherche..." class="hover:border-white-300 hover:border-1 rounded-sm hidden test" autocomplete="off" size="30">
        <div id="resultats" class="absolute bg-white border border-gray-300 w-full mt-1 max-h-60 overflow-auto z-10 text-gray-500 hidden test"></div>
       </div>
        <i class="fa-solid fa-magnifying-glass hover:text-amber-300"></i>
        <a href="/agendas/list" class="hover:text-amber-300 test">Mes agendas</a>
        <a href="/calendar/week" class="hover:text-amber-300 test">Calendrier</a>
        <a href="/appointment/new" class="hover:text-amber-300 test">Nouveau RDV</a>
        <a href="/notifications" class="relative">
          <i class="fa fa-bell text-xl"></i>
          <% if (notificationCount > 0) { %>
            <span class="absolute -top-1 -right-2 bg-red-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
              <%= notificationCount %>
            </span>
          <% } %>
        </a>
      <% } %>

        <i class="fa fa-sun" data-action="theme"></i>

      <% if (!user) {%>
        <a href="/login" class="ml-4 px-3 py-1 bg-amber-500 text-stone-900 rounded hover:bg-amber-600">Connexion</a>
        <a href="/register" class="ml-2 px-3 py-1 bg-amber-400 text-stone-900 rounded hover:bg-amber-500">Inscription</a>
      <% } else { %>
        <a href="/logout" class="ml-2 px-3 py-1 bg-red-400 text-stone-900 rounded hover:bg-red-500">Déconnexion</a>
        <a href="/profile" class="rounded-full flex items-center justify-center border-2 border-stone-500 w-12 h-12 cursor-pointer">
          <% if (!user.profile_picture) { %>
            <i class="fa fa-user text-2xl"></i>
          <% } else { %>
            <img src="<%=user.profile_picture%>" alt="" class="w-full h-full rounded-full">
          <% }%>
        </a>
      <% } %>
    </nav>
  </div>
</header>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    let variableI = document.querySelector(".fa-magnifying-glass");
    let recherche = document.querySelector("#recherche");
    let visible = document.querySelectorAll(".test");
    let resultats = document.querySelector("#resultats");

    // permet le bon affichage de la barre de recherche
    const afficherCacherRecherche = () => {
        visible.forEach(element => {
            element.classList.toggle("hidden");
        });
    }

    // listener pour afficher la barre de recherche et mettre le focus dessus
    variableI.addEventListener("click", () => {
        afficherCacherRecherche();
        if(visible){
          recherche.focus();
        }
    })

    // permet d'enlever l'affichage de la barre de recherche lorsqu'on enleve le focus
    recherche.addEventListener("blur", () => {
        recherche.value="";
        resultats.innerHTML="";
        afficherCacherRecherche();
    })

    // Permet la recherche dans la bdd des rendez vous et l'affichage du jour du rdv si on clique dessus
    recherche.addEventListener("input", () => { 
        let str = recherche.value;
        fetch("/api/rechercher/recherche", {
          method: "POST",
          headers: { "Content-Type": "application/json;charset=UTF-8" },
          body: JSON.stringify({str})
        })
        .then(response => {
          // Traitement erreur 404
          if(!response.ok) {
            throw new Error("Erreur 404 lors de la recherche de rendez-vous (header.js)");
          }
          return response.json();
        }) 
        .then(data => { // utilisation des données résultats
          let newTextResultat="";
          if (data && data.length > 0) {
            data.forEach(element => {
              const date = new Date(element.date_Debut);
              const day = date.getUTCDate();             
              const month = date.getUTCMonth();
              const year = date.getUTCFullYear();
            
              // création d’un lien cliquable
              newTextResultat += `
                <div class="p-2 hover:bg-gray-200 cursor-pointer" onclick="window.location.href='/calendar/day?day=${day}&month=${month}&year=${year}'">
                  ${element.nom} - ${day}/${month}/${year}
                </div>`;
            });
          }
          resultats.innerHTML=newTextResultat;
        }).catch(err => console.error(err));
    });
  })
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  let theme_picker_el = document.querySelector('i[data-action="theme"]');

  theme_picker_el.addEventListener("click", () => {
    let is_dark = document.body.classList.contains("dark");

    if (is_dark) {

    }

    theme_picker_el.classList.toggle("fa-sun");   
    theme_picker_el.classList.toggle("fa-moon");    
    document.body.classList.toggle("dark");
    document.body.classList.toggle("light");
  })
})  
</script>