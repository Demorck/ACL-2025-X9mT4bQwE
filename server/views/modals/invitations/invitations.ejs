<% layout("modals/template"); %>

<div class="flex flex-col gap-6 text-left items-stretch" data-agenda-id="<%= agenda._id %>" data-user-niveau="<%= niveau %>">
    <% if(niveau >= 3) { %>
    <!-- PARTIE GAUCHE : LIENS D'INVITATION -->
    <div class="w-full md:flex-2 flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Liens d'invitation</h3>
            
            <button 
                data-action="create-invitation"
                data-agenda-id="<%= agenda._id %>"
                class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm font-semibold transition-colors cursor-pointer"
            >
                + Nouveau lien
            </button>
        </div>

        <div class="invitation-links-container space-y-2 flex-1 overflow-y-auto max-h-96">
            <% if (typeof invitations !== 'undefined' && invitations.length > 0) { %>
                <% invitations.forEach(inv => { %>
                    <div class="invitation-link-card card item-list rounded-lg p-4 transition-colors group"
                         data-invitation-id="<%= inv._id %>">
                        
                        <!-- En-tête avec ID et actions -->
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="card-header px-3 py-1 rounded font-mono text-sm">
                                    ...<%= inv._id.toString().slice(-8) %>
                                </div>
                                
                                <button type="button"
                                        class="cursor-pointer copy-link-btn p-2 card-header hover:bg-stone-500 rounded transition-colors relative flex items-center"
                                        data-invitation-id="<%= inv._id %>"
                                        title="Copier le lien">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    
                                <span class="copy-feedback text-green-400 text-xs top-0 left-0 font-bold opacity-0 transition-opacity absolute animate-ping"></span>
                                </button>
                                
                            </div>
                            
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">                                
                                <button type="button"
                                        class="cursor-pointer delete-invitation-btn p-2 bg-red-600 hover:bg-red-700 rounded transition-colors"
                                        data-invitation-id="<%= inv._id %>"
                                        title="Supprimer">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Informations -->
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-stone-400">Utilisations :</span>
                                <span class="font-semibold ml-2"><%= inv.nbUtilisation %> / <%= inv.utilisationsMax || '∞' %></span>
                            </div>
                            
                            <div>
                                <span class="text-stone-400">Expiration :</span>
                                <span class="font-semibold ml-2">
                                    <%= inv.dateExpiration ? new Date(inv.dateExpiration).toLocaleDateString("fr-FR") : 'Jamais' %>
                                </span>
                            </div>
                        </div>
                    </div>
                <% }) %>
            <% } else { %>
                <div class="text-center py-12 text-stone-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                    </svg>
                    <p class="text-sm italic">Aucun lien d'invitation actif</p>
                    <p class="text-xs mt-1">Créez-en un pour inviter des membres</p>
                </div>
            <% } %>
        </div>
    </div>
    <% } %>
    
    <!-- PARTIE DROITE : MEMBRES -->
    <div class="w-full md:flex-1 flex flex-col">
        <h3 class="text-xl font-semibold mb-4 members-count">
            Membres (<%= invites.length %>)
        </h3>
        
        <div class="card rounded-lg border p-3 flex-1 overflow-y-auto max-h-96">
            <% if (invites && invites.length > 0) { %>
                <div class="space-y-2 members-list">
                    <% invites.forEach(u => { %>
                        <div class="member-card rounded-lg p-3 flex items-center justify-between gap-3 transition-colors"
                             data-member-id="<%= u.user._id %>">
                            
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <!-- Avatar -->
                                <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="text-sm font-bold">
                                        <%= u.user.username.substring(0, 2).toUpperCase() %>
                                    </span>
                                </div>
                                
                                <!-- Nom -->
                                <div class="flex-1 min-w-0">
                                    <p class="font-semibold truncate"><%= u.user.username %></p>
                                    <p class="text-xs text-stone-400">
                                        <%= u.niveau === 3 ? 'Admin' : u.niveau === 2 ? 'Member' : 'Viewer' %>
                                    </p>
                                </div>
                            </div>
                            
                            <% if(niveau >= 3) { %>
                                <div class="flex items-center gap-2 flex-shrink-0">
                                    <!-- Sélecteur de rôle -->
                                    <select class="role-select px-2 py-1 rounded text-xs border"
                                            data-agenda-id="<%= agenda._id %>"
                                            data-user-id="<%= u.user._id %>"
                                            <%= u.niveau === niveau ? 'disabled' : '' %>>
                                        <option value="3" <%= u.niveau == 3 ? 'selected' : '' %>>Admin</option>
                                        <option value="2" <%= u.niveau == 2 ? 'selected' : '' %>>Member</option>
                                        <option value="1" <%= u.niveau == 1 ? 'selected' : '' %>>Viewer</option>
                                    </select>
                                    
                                    <!-- Bouton supprimer -->
                                    <button type="button"
                                            class="cursor-pointer remove-member-btn p-2 bg-red-600 hover:bg-red-700 rounded transition-colors"
                                            data-agenda-id="<%= agenda._id %>"
                                            data-user-id="<%= u.user._id %>"
                                            title="Retirer du groupe">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            <% } %>
                        </div>
                    <% }) %>
                </div>
            <% } else { %>
                <div class="flex h-full items-center justify-center members-list">
                    <div class="text-center text-stone-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <p class="text-sm italic">Aucun membre invité</p>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>